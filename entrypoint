#!/usr/bin/env bash

set -eo pipefail

################################################################################
# Validate Inputs
################################################################################

function usage {
    echo "usage: $0 [webhook] [channel] [app] [sha]"
    echo "  name         name of the app (eg. Broadband Plans)"
    echo "  namespace    Kuberenetes namespace to deploy to (eg. fuchsia)"
    echo "  overlay      Kubstomize overlay to apply (eg. staging...)"
    exit 1
}

[ -z "$3" ] && { usage; }

################################################################################
# Set Inputs
################################################################################

NAME="$1"
NAMESPACE="$2"
OVERLAY="$3"

################################################################################
# Set Variables
################################################################################

TAG="${GITHUB_SHA::7}"
APP="${GITHUB_REPOSITORY/switcher-ie\//}"

################################################################################
# Set Path
################################################################################

export PATH="$PATH:/deploy"

################################################################################
# Login to ECR
################################################################################

$(aws ecr get-login --no-include-email)

################################################################################
# Build Image
################################################################################

build "${TAG}" "${GITHUB_SHA}" "${APP}"

################################################################################
# Push Image
################################################################################

push "${TAG}" "${APP}"
