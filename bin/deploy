#!/usr/bin/env bash

set -eo pipefail

################################################################################
# Validate Inputs
################################################################################

function usage {
    echo "usage: $0 [namespace] [overlay]"
    echo "  namespace    namespace to promote the image (eg. indigo)"
    echo "  overlay      kustomize overlay to apply (eg. staging)"
    exit 1
}

[ -z "$1" ] && { usage; }

################################################################################
# Set Inputs
################################################################################

NAMESPACE=$1
OVERLAY=$2

################################################################################
# Constants
################################################################################

DIR="$(dirname "${BASH_SOURCE[0]}")"

################################################################################
# Setup Environment
################################################################################

source ${DIR}/env

################################################################################
# Set Variables
################################################################################

TAG=$(git rev-parse --short HEAD)
GIT_SHA=$(git rev-parse HEAD)
IMAGE="$ENDPOINT/$APP:$TAG"

################################################################################
# Build Image
################################################################################

$debug ${DIR}/build $TAG $TAG

################################################################################
# Push Image
################################################################################

$debug ${DIR}/push $TAG $GIT_SHA

################################################################################
# Promote Image
################################################################################

$debug ${DIR}/promote $NAMESPACE $OVERLAY $TAG
