#!/usr/bin/env bash

set -eo pipefail

################################################################################
# Validate Inputs
################################################################################

function usage {
    echo "usage: $0 [namespace] [tag]"
    echo "  namespace    namespace to promote the image (eg. production)"
    echo "  tag          tag of the image version (eg. latest)"
    exit 1
}

[ -z "$1" ] && { usage; }

################################################################################
# Set Inputs
################################################################################

NAMESPACE=$1
TAG=$2

################################################################################
# Constants
################################################################################

DIR="$(dirname "${BASH_SOURCE[0]}")"
ROOT="$(readlink -f ${DIR}/../../../)"
DEPLOY="${ROOT}/deploy"

################################################################################
# Setup Environment
################################################################################

source ${DIR}/../env

################################################################################
# Set Variables
################################################################################

REPOSITORY="$ENDPOINT/$APP"

################################################################################
# Set migration properties
################################################################################

pushd $DEPLOY/pre-release
$debug kustomize edit set image unset=$REPOSITORY:$TAG
popd

################################################################################
# Cleanup old migration jobs
################################################################################

if kubectl get jobs -n $NAMESPACE | grep -q $APP-migration; then
  $debug kubectl delete job/$APP-migration -n $NAMESPACE
fi

################################################################################
# Run migration
################################################################################

$debug kubectl apply -k $DEPLOY/pre-release -n $NAMESPACE
$debug kubectl wait --for=condition=complete job/$APP-migration --timeout=15m -n $NAMESPACE

################################################################################
# Cleanup migration job
################################################################################
$debug kubectl delete job/$APP-migration -n $NAMESPACE
